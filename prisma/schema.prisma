// ALX Partnership Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  REVIEWER
  TEAM_MEMBER
  SCHEDULER
}

enum RequestStatus {
  NEW
  UNDER_REVIEW
  APPROVED
  REJECTED
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum PartnershipType {
  SPEAKER
  EVENT
  RECRUITMENT
  SPONSORSHIP
  OTHER
}

enum HubName {
  CAPSTONE
  CITYPOINT
  VIRTUAL
}

enum EventStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  ASSIGNMENT
  COMMENT
  FILE_UPLOAD
}

// ============================================
// MODELS
// ============================================

/// Internal ALX staff users
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  fullName      String   @map("full_name")
  role          UserRole @default(REVIEWER)
  googleSubId   String?  @unique @map("google_sub_id") // Google OAuth subject ID
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  assignedRequests Request[]  @relation("AssignedTo")
  auditLogs        AuditLog[]
  comments         Comment[]

  @@index([email])
  @@index([role])
  @@map("users")
}

/// External partner organizations
model Partner {
  id        String   @id @default(uuid())
  orgName   String   @map("org_name")
  pocEmail  String   @map("poc_email")
  pocPhone  String   @map("poc_phone")
  orgUrl    String?  @map("org_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  requests Request[]

  @@index([pocEmail])
  @@map("partners")
}

/// Physical or virtual hubs
model Hub {
  id        String   @id @default(uuid())
  name      HubName
  timezone  String   @default("Africa/Nairobi") // IANA timezone
  openTime  String   @default("09:00") // HH:MM format
  closeTime String   @default("20:00") // HH:MM format
  isActive  Boolean  @default(true) @map("is_active")
  address   String?
  capacity  Int?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  requests Request[]
  events   Event[]

  @@unique([name])
  @@map("hubs")
}

/// Partnership intake requests (central entity)
model Request {
  id              String          @id @default(uuid())
  partnerId       String          @map("partner_id")
  status          RequestStatus   @default(NEW)
  hubId           String          @map("hub_id")
  assignedToId    String?         @map("assigned_to_id")
  
  // Form Data (from intake)
  eventTitle      String          @map("event_title")
  eventDesc       String          @map("event_desc") @db.Text
  partnershipType PartnershipType @map("partnership_type")
  requestedDate   DateTime        @map("requested_date") @db.Date
  startTime       String          @map("start_time") // HH:MM
  endTime         String          @map("end_time")   // HH:MM
  attendeeCount   Int             @map("attendee_count")
  
  // Computed/Metadata
  requiresMou     Boolean         @default(false) @map("requires_mou")
  submissionData  Json            @map("submission_data") // Full form snapshot (JSONB)
  
  // Files
  conceptNoteUrl  String?         @map("concept_note_url")
  logoUrl         String?         @map("logo_url")
  
  // Timestamps
  submittedAt     DateTime        @default(now()) @map("submitted_at")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  partner     Partner    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  hub         Hub        @relation(fields: [hubId], references: [id])
  assignedTo  User?      @relation("AssignedTo", fields: [assignedToId], references: [id])
  events      Event[]
  comments    Comment[]
  auditLogs   AuditLog[]

  @@index([status])
  @@index([partnerId])
  @@index([hubId])
  @@index([assignedToId])
  @@index([requestedDate])
  @@index([submittedAt])
  @@map("requests")
}

/// Calendar events (approved requests become events)
model Event {
  id                String      @id @default(uuid())
  requestId         String      @map("request_id")
  title             String
  description       String?     @db.Text
  startDatetime     DateTime    @map("start_datetime")
  endDatetime       DateTime    @map("end_datetime")
  hubId             String      @map("hub_id")
  status            EventStatus @default(TENTATIVE)
  roomResource      String?     @map("room_resource") // Optional room/space identifier
  googleCalEventId  String?     @unique @map("google_cal_event_id") // Sync with Google Calendar
  colorCode         String      @default("#3B82F6") @map("color_code") // For calendar UI
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  hub     Hub     @relation(fields: [hubId], references: [id])

  @@index([hubId])
  @@index([startDatetime])
  @@index([endDatetime])
  @@index([status])
  // Prevent overlapping events in same hub (enforced in application logic)
  @@map("events")
}

/// Comments/notes on requests
model Comment {
  id        String   @id @default(uuid())
  requestId String   @map("request_id")
  userId    String   @map("user_id")
  content   String   @db.Text
  isInternal Boolean @default(true) @map("is_internal") // Internal notes vs partner-visible
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  request Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([requestId])
  @@index([userId])
  @@index([createdAt])
  @@map("comments")
}

/// Audit trail for all changes
model AuditLog {
  id         String      @id @default(uuid())
  entityType String      @map("entity_type") // Request, Event, User, etc.
  entityId   String      @map("entity_id")
  userId     String?     @map("user_id") // Null for system actions
  action     AuditAction
  prevValue  Json?       @map("prev_value") // Previous state (JSONB)
  newValue   Json?       @map("new_value")  // New state (JSONB)
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  timestamp  DateTime    @default(now())

  // Relations
  user    User?    @relation(fields: [userId], references: [id])
  request Request? @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([timestamp])
  @@map("audit_logs")
}

/// Notification queue for email tracking
model Notification {
  id          String   @id @default(uuid())
  recipientEmail String @map("recipient_email")
  subject     String
  templateName String  @map("template_name")
  templateData Json    @map("template_data") // Variables for template
  sentAt      DateTime? @map("sent_at")
  failedAt    DateTime? @map("failed_at")
  errorMessage String? @map("error_message") @db.Text
  retryCount  Int      @default(0) @map("retry_count")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([recipientEmail])
  @@index([sentAt])
  @@index([createdAt])
  @@map("notifications")
}

/// System configuration (hub holidays, blackout dates, etc.)
model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "hub_holidays_2025", "maintenance_mode"
  value     Json     // Flexible JSON storage
  updatedBy String?  @map("updated_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

/// Rate limiting tracking
model RateLimit {
  id         String   @id @default(uuid())
  identifier String   // IP address or email
  action     String   // e.g., "submit_form"
  count      Int      @default(1)
  windowStart DateTime @map("window_start")
  expiresAt  DateTime @map("expires_at")

  @@unique([identifier, action, windowStart])
  @@index([identifier, action])
  @@index([expiresAt])
  @@map("rate_limits")
}
